{% extends "base.html" %}

{% block title %}Dashboard - Briefen{% endblock %}

{% block content %}
<div class="container">
    <h2>Your Shortened URLs</h2>

    {% if urls %}
        <div class="dashboard-urls">
            {% for url in urls %}
                <div class="url-card" id="card-{{ url.id }}">
                    <div class="url-info">
                        <div class="url-slug" id="slug-display-{{ url.id }}">
                            <strong>{{ request.host_url }}<span id="slug-text-{{ url.id }}">{{ url.slug }}</span></strong>
                        </div>
                        <div class="edit-section hidden" id="edit-section-{{ url.id }}">
                            <label for="edit-input-{{ url.id }}">Edit Slug</label>
                            <div class="edit-input-group">
                                <span class="url-prefix">{{ request.host_url }}</span>
                                <input
                                    type="text"
                                    id="edit-input-{{ url.id }}"
                                    value="{{ url.slug }}"
                                    pattern="[a-z0-9-]+"
                                    maxlength="50"
                                    placeholder="your-custom-slug"
                                />
                                <button type="button" class="btn-secondary" onclick="saveSlug({{ url.id }})">Save</button>
                                <button type="button" class="btn-secondary" onclick="cancelEdit({{ url.id }})">Cancel</button>
                            </div>
                            <span class="edit-hint">Only lowercase letters, numbers, and hyphens allowed</span>
                        </div>
                        <div class="url-original" id="url-display-{{ url.id }}">
                            Original: <span id="url-text-{{ url.id }}">{{ url.original_url }}</span>
                        </div>
                        {% if current_user.is_subadmin %}
                        <div class="edit-url-section hidden" id="edit-url-section-{{ url.id }}">
                            <label for="edit-url-input-{{ url.id }}">Edit Destination URL</label>
                            <div class="edit-input-group">
                                <input
                                    type="url"
                                    id="edit-url-input-{{ url.id }}"
                                    value="{{ url.original_url }}"
                                    placeholder="https://example.com/page"
                                    class="edit-url-input"
                                />
                                <button type="button" class="btn-secondary" onclick="saveUrl({{ url.id }})">Save</button>
                                <button type="button" class="btn-secondary" onclick="cancelUrlEdit({{ url.id }})">Cancel</button>
                            </div>
                            <span class="edit-hint">Enter a valid URL starting with http:// or https://</span>
                        </div>
                        {% endif %}
                        <div class="url-meta">
                            Created: {{ url.created_at.strftime('%Y-%m-%d %H:%M') }} | Clicks: {{ url.click_count }}
                        </div>
                    </div>
                    <div class="url-actions">
                        <button type="button" onclick="copyUrl('{{ request.host_url }}{{ url.slug }}')" aria-label="Copy URL {{ url.slug }}">Copy</button>
                        <button type="button" class="qr-btn" onclick="downloadQRCode({{ url.id }}, '{{ url.slug }}')" aria-label="Download QR code for {{ url.slug }}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                            QR Code
                        </button>
                        <a href="{{ url_for('web.analytics', slug=url.slug) }}" class="analytics-btn" aria-label="View analytics for {{ url.slug }}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                            Analytics
                        </a>
                        <button type="button" id="edit-btn-{{ url.id }}" onclick="startEdit({{ url.id }}, '{{ url.slug }}')" aria-label="Edit slug {{ url.slug }}">Edit Slug</button>
                        {% if current_user.is_subadmin %}
                        <button type="button" id="edit-url-btn-{{ url.id }}" onclick="startUrlEdit({{ url.id }})" aria-label="Edit destination URL">Edit URL</button>
                        {% endif %}
                        <form method="POST" action="{{ url_for('web.delete_url', url_id=url.id) }}" class="delete-form">
                            <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this link?')" aria-label="Delete URL {{ url.slug }}">Delete</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if pagination.pages > 1 %}
        <div class="pagination">
            {% if pagination.has_prev %}
            <a href="{{ url_for('web.dashboard', page=pagination.prev_num) }}" class="pagination-btn">&laquo; Previous</a>
            {% else %}
            <span class="pagination-btn disabled">&laquo; Previous</span>
            {% endif %}

            <span class="pagination-info">
                Page {{ pagination.page }} of {{ pagination.pages }}
            </span>

            {% if pagination.has_next %}
            <a href="{{ url_for('web.dashboard', page=pagination.next_num) }}" class="pagination-btn">Next &raquo;</a>
            {% else %}
            <span class="pagination-btn disabled">Next &raquo;</span>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <p>You haven't created any short links yet.</p>
            <a href="{{ url_for('web.create') }}" class="btn">Create Your First Link</a>
        </div>
    {% endif %}
</div>

<script>
function copyUrl(url) {
    navigator.clipboard.writeText(url).then(() => {
        alert('URL copied to clipboard!');
    });
}

async function downloadQRCode(urlId, slug) {
    try {
        // Create a temporary link element to trigger download
        const link = document.createElement('a');
        link.href = `/api/qrcode/${urlId}`;
        link.download = `qrcode-${slug}.png`;

        // Trigger the download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Error downloading QR code:', error);
        alert('Error downloading QR code: ' + error.message);
    }
}

function startEdit(urlId, currentSlug) {
    // Hide the slug display
    document.getElementById(`slug-display-${urlId}`).classList.add('hidden');
    // Show the edit section
    document.getElementById(`edit-section-${urlId}`).classList.remove('hidden');
    // Focus on the input
    document.getElementById(`edit-input-${urlId}`).focus();
    document.getElementById(`edit-input-${urlId}`).select();
}

function cancelEdit(urlId) {
    // Show the slug display
    document.getElementById(`slug-display-${urlId}`).classList.remove('hidden');
    // Hide the edit section
    document.getElementById(`edit-section-${urlId}`).classList.add('hidden');
    // Reset the input to original value
    const originalSlug = document.getElementById(`slug-text-${urlId}`).textContent;
    document.getElementById(`edit-input-${urlId}`).value = originalSlug;
}

async function saveSlug(urlId) {
    const input = document.getElementById(`edit-input-${urlId}`);
    const newSlug = input.value.trim();
    const currentSlug = document.getElementById(`slug-text-${urlId}`).textContent;

    if (!newSlug || newSlug === currentSlug) {
        cancelEdit(urlId);
        return;
    }

    // Validate slug format
    if (!/^[a-z0-9-]+$/.test(newSlug)) {
        alert('Slug can only contain lowercase letters, numbers, and hyphens');
        input.focus();
        return;
    }

    if (newSlug.length > 50) {
        alert('Slug must be 50 characters or less');
        input.focus();
        return;
    }

    // Disable the input and buttons while saving
    input.disabled = true;
    const saveBtn = event.target;
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    try {
        const response = await fetch(`/api/edit-slug/${urlId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ slug: newSlug })
        });

        const data = await response.json();

        if (data.success) {
            // Update the slug text
            document.getElementById(`slug-text-${urlId}`).textContent = data.new_slug;
            // Hide edit section and show display
            cancelEdit(urlId);
            // Show success message
            showFlashMessage('Slug updated successfully!', 'success');
        } else {
            alert('Error: ' + (data.error || 'Failed to update slug'));
            input.disabled = false;
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        }
    } catch (error) {
        console.error('Error editing slug:', error);
        alert('Error editing slug: ' + error.message);
        input.disabled = false;
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
    }
}

function showFlashMessage(message, type) {
    const flash = document.createElement('div');
    flash.className = `flash flash-${type}`;
    flash.textContent = message;
    flash.style.position = 'fixed';
    flash.style.top = '20px';
    flash.style.right = '20px';
    flash.style.zIndex = '1000';
    flash.style.maxWidth = '400px';
    document.body.appendChild(flash);

    setTimeout(() => {
        flash.style.opacity = '0';
        flash.style.transition = 'opacity 0.3s ease';
        setTimeout(() => flash.remove(), 300);
    }, 3000);
}

function startUrlEdit(urlId) {
    // Hide the URL display
    document.getElementById(`url-display-${urlId}`).classList.add('hidden');
    // Show the edit URL section
    document.getElementById(`edit-url-section-${urlId}`).classList.remove('hidden');
    // Focus on the input
    const input = document.getElementById(`edit-url-input-${urlId}`);
    input.focus();
    input.select();
}

function cancelUrlEdit(urlId) {
    // Show the URL display
    document.getElementById(`url-display-${urlId}`).classList.remove('hidden');
    // Hide the edit URL section
    document.getElementById(`edit-url-section-${urlId}`).classList.add('hidden');
    // Reset the input to original value
    const originalUrl = document.getElementById(`url-text-${urlId}`).textContent;
    document.getElementById(`edit-url-input-${urlId}`).value = originalUrl;
}

async function saveUrl(urlId) {
    const input = document.getElementById(`edit-url-input-${urlId}`);
    const newUrl = input.value.trim();
    const currentUrl = document.getElementById(`url-text-${urlId}`).textContent;

    if (!newUrl || newUrl === currentUrl) {
        cancelUrlEdit(urlId);
        return;
    }

    // Basic URL validation
    if (!newUrl.startsWith('http://') && !newUrl.startsWith('https://')) {
        alert('URL must start with http:// or https://');
        input.focus();
        return;
    }

    // Disable the input and buttons while saving
    input.disabled = true;
    const saveBtn = event.target;
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    try {
        const response = await fetch(`/api/edit-url/${urlId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ original_url: newUrl })
        });

        const data = await response.json();

        if (data.success) {
            // Update the URL text
            document.getElementById(`url-text-${urlId}`).textContent = data.new_url;
            // Hide edit section and show display
            cancelUrlEdit(urlId);
            // Show success message
            showFlashMessage('Destination URL updated successfully!', 'success');
        } else {
            alert('Error: ' + (data.error || 'Failed to update URL'));
            input.disabled = false;
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        }
    } catch (error) {
        console.error('Error editing URL:', error);
        alert('Error editing URL: ' + error.message);
        input.disabled = false;
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
    }
}
</script>
{% endblock %}